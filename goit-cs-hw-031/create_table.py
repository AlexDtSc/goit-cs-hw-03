import psycopg2  # –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ psycopg2, —è–∫–∞ –¥–æ–∑–≤–æ–ª—è—î Python –ø—ñ–¥–∫–ª—é—á–∞—Ç–∏—Å—å –¥–æ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö PostgreSQL —Ç–∞ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ SQL-–∑–∞–ø–∏—Ç–∏.

from dotenv import load_dotenv # –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î –∑–º—ñ–Ω–Ω—ñ –∑ .env —É —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ
import os


# –ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è (–∑–≥—ñ–¥–Ω–æ –∑ docker-compose.yml) –≤–∑—è—Ç—ñ .env —Ñ–∞–π–ª–∞ –∑ –º–µ—Ç–æ—é –ø—Ä–∏—Ö–æ–≤–∞–Ω–Ω—è –æ—Å–æ–±–∏—Å—Ç–∏—Ö –¥–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
load_dotenv()   # –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î –∑–º—ñ–Ω–Ω—ñ –∑ .env —É —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ

db_config = {                           
    'host': os.getenv("DB_HOST"),
    'port': os.getenv("DB_PORT"),
    'dbname': os.getenv("DB_NAME"),
    'user': os.getenv("DB_USER"),
    'password': os.getenv("DB_PASSWORD")
}

# SQL-–∑–∞–ø–∏—Ç–∏
sql_query = """
DROP TABLE IF EXISTS tasks;
DROP TABLE IF EXISTS status;
DROP TABLE IF EXISTS users;

CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  fullname VARCHAR(100),
  email VARCHAR(100) UNIQUE
);

CREATE TABLE status (
  id SERIAL PRIMARY KEY,
  name VARCHAR(50) UNIQUE
);

CREATE TABLE tasks (
  id SERIAL PRIMARY KEY,
  title VARCHAR(100),
  description TEXT,
  status_id INTEGER,
  user_id INTEGER,
  FOREIGN KEY (status_id) REFERENCES status(id),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
"""

def create_tables(): 
    try:
        # –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö
        connection = psycopg2.connect(**db_config)   # –°—Ç–≤–æ—Ä—é—î –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ –±–∞–∑–æ—é —á–µ—Ä–µ–∑ psycopg2.connect(...).

        connection.autocommit = True    # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î autocommit = True, —â–æ–± –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –±—É–ª–æ –≤—Ä—É—á–Ω—É –≤–∏–∫–ª–∏–∫–∞—Ç–∏ connection.commit(). 
        cursor = connection.cursor()    # –°—Ç–≤–æ—Ä—é—î –∫—É—Ä—Å–æ—Ä (cursor) ‚Äî –æ–±‚Äô—î–∫—Ç, —á–µ—Ä–µ–∑ —è–∫–∏–π –º–æ–∂–Ω–∞ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ SQL-–∑–∞–ø–∏—Ç–∏.

        # –í–∏–∫–æ–Ω–∞–Ω–Ω—è SQL
        cursor.execute(sql_query)              # –ö—É—Äc–æ—Ä –≤–∏–∫–æ–Ω—É—î SQL-–∑–∞–ø–∏—Ç–∏ –∑ sql_query, —è–∫—ñ –º–∏ –ø—ñ–¥–≥–æ—Ç—É–≤–∞–ª–∏ —Ä–∞–Ω—ñ—à–µ.
        print("–¢–∞–±–ª–∏—Ü—ñ —É—Å–ø—ñ—à–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω—ñ.")

    except Exception as e:
        print("–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—å:", e)

    finally:
        if connection:            # –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö ‚Äî –≤–∞–∂–ª–∏–≤–æ, —â–æ–± –Ω–µ –±—É–ª–æ "–≤–∏—Å—è—á–∏—Ö" –∑'—î–¥–Ω–∞–Ω—å.
            cursor.close()
            connection.close()

if __name__ == "__main__":
    create_tables()


##### –ó–∞–≤–¥–∞–Ω–Ω—è 1.1 (–∞–Ω–∞–ª–æ–≥ –≤ python —Ç–æ–≥–æ, —â–æ –∑—Ä–æ–±–∏–ª–∏ –≤ DBeaver —Ñ–∞–π–ª—ñ sql_create_table.sql)

'''
–ü–æ–∫—Ä–æ–∫–æ–≤–∞ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è

1. –°—Ç–≤–æ—Ä—ñ—Ç—å —Ç–∞–±–ª–∏—Ü—ñ —É –≤–∞—à—ñ–π PostgreSQL –±–∞–∑—ñ –¥–∞–Ω–∏—Ö –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ –≤–∏–º–æ–≥. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –Ω–∞–ª–µ–∂–Ω—ñ —Ç–∏–ø–∏ –¥–∞–Ω–∏—Ö —Ç–∞ –æ–±–º–µ–∂–µ–Ω–Ω—è.

–í–∏–º–æ–≥–∏ –¥–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö:


1.1. –¢–∞–±–ª–∏—Ü—è users:

id: –ü–µ—Ä–≤–∏–Ω–Ω–∏–π –∫–ª—é—á, –∞–≤—Ç–æ—ñ–Ω–∫—Ä–µ–º–µ–Ω—Ç (—Ç–∏–ø SERIAL),
fullname: –ü–æ–≤–Ω–µ —ñ–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (—Ç–∏–ø VARCHAR(100)),
email: –ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ –∞–¥—Ä–µ—Å–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —è–∫–∞ –ø–æ–≤–∏–Ω–Ω–∞ –±—É—Ç–∏ —É–Ω—ñ–∫–∞–ª—å–Ω–æ—é (—Ç–∏–ø VARCHAR(100)).


1.2. –¢–∞–±–ª–∏—Ü—è status:

id: –ü–µ—Ä–≤–∏–Ω–Ω–∏–π –∫–ª—é—á, –∞–≤—Ç–æ—ñ–Ω–∫—Ä–µ–º–µ–Ω—Ç (—Ç–∏–ø SERIAL),
name: –ù–∞–∑–≤–∞ —Å—Ç–∞—Ç—É—Å—É (—Ç–∏–ø VARCHAR(50)), –ø–æ–≤–∏–Ω–Ω–∞ –±—É—Ç–∏ —É–Ω—ñ–∫–∞–ª—å–Ω–æ—é. –ü—Ä–æ–ø–æ–Ω—É—î–º–æ –Ω–∞—Å—Ç—É–ø–Ω—ñ —Ç–∏–ø–∏ [('new',), ('in progress',), ('completed',)].


1.3. –¢–∞–±–ª–∏—Ü—è tasks:

id: –ü–µ—Ä–≤–∏–Ω–Ω–∏–π –∫–ª—é—á, –∞–≤—Ç–æ—ñ–Ω–∫—Ä–µ–º–µ–Ω—Ç (—Ç–∏–ø SERIAL),
title: –ù–∞–∑–≤–∞ –∑–∞–≤–¥–∞–Ω–Ω—è (—Ç–∏–ø VARCHAR(100)),
description: –û–ø–∏—Å –∑–∞–≤–¥–∞–Ω–Ω—è (—Ç–∏–ø TEXT),
status_id: –ó–æ–≤–Ω—ñ—à–Ω—ñ–π –∫–ª—é—á, —â–æ –≤–∫–∞–∑—É—î –Ω–∞ id —É —Ç–∞–±–ª–∏—Ü—ñ status (—Ç–∏–ø INTEGER),
user_id: –ó–æ–≤–Ω—ñ—à–Ω—ñ–π –∫–ª—é—á, —â–æ –≤–∫–∞–∑—É—î –Ω–∞ id —É —Ç–∞–±–ª–∏—Ü—ñ users (—Ç–∏–ø INTEGER).


2. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –ø–æ–ª—è email —É —Ç–∞–±–ª–∏—Ü—ñ users —Ç–∞ name —É —Ç–∞–±–ª–∏—Ü—ñ status —î —É–Ω—ñ–∫–∞–ª—å–Ω–∏–º–∏.

3. –ù–∞–ª–∞—à—Ç—É–π—Ç–µ –∑–≤'—è–∑–∫–∏ –º—ñ–∂ —Ç–∞–±–ª–∏—Ü—è–º–∏ —Ç–∞–∫–∏–º —á–∏–Ω–æ–º, —â–æ–± –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–¥–∞–ª—è–ª–∏—Å—è –≤—Å—ñ –π–æ–≥–æ –∑–∞–≤–¥–∞–Ω–Ω—è (–∫–∞—Å–∫–∞–¥–Ω–µ –≤–∏–¥–∞–ª–µ–Ω–Ω—è).

4. –ù–∞–ø–∏—à—ñ—Ç—å —Å–∫—Ä–∏–ø—Ç —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ü–∏—Ö —Ç–∞–±–ª–∏—Ü—å.
'''


### –ü–æ—è—Å–Ω–µ–Ω–Ω—è –¥–æ –∫–æ–¥—É
'''
üß† –©–æ —Ç–∞–∫–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è —É SQL?
–£ SQL –±—É–¥—å-—è–∫–∏–π –∑–∞–ø–∏—Ç, —è–∫–∏–π –∑–º—ñ–Ω—é—î –¥–∞–Ω—ñ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, INSERT, UPDATE, DELETE, CREATE TABLE, DROP TABLE, —ñ —Ç.–¥.) –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –≤ –º–µ–∂–∞—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó.

üîÅ –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è ‚Äî —Ü–µ:
–ª–æ–≥—ñ—á–Ω–∞ –≥—Ä—É–ø–∞ –æ–ø–µ—Ä–∞—Ü—ñ–π, —è–∫—ñ –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è —è–∫ –æ–¥–Ω–µ —Ü—ñ–ª–µ (—É—Å–ø—ñ—à–Ω–æ –∞–±–æ –Ω—ñ),
–¥–æ –º–æ–º–µ–Ω—Ç—É –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è (—á–µ—Ä–µ–∑ COMMIT) ‚Äî –∑–º—ñ–Ω–∏ –Ω–µ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –æ—Å—Ç–∞—Ç–æ—á–Ω–æ.

üîß –ü–æ–≤–µ–¥—ñ–Ω–∫–∞ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º —É psycopg2
–£ –±—ñ–±–ª—ñ–æ—Ç–µ—Ü—ñ psycopg2:

–ø—ñ—Å–ª—è connect(...) –∑'—î–¥–Ω–∞–Ω–Ω—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–≤–æ—Ä—é—î —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é;
–∫–æ–ª–∏ —Ç–∏ –≤–∏–∫–æ–Ω—É—î—à cursor.execute(...), –∑–º—ñ–Ω–∏ –≤—ñ–¥–±—É–≤–∞—é—Ç—å—Å—è –ª–∏—à–µ —Ç–∏–º—á–∞—Å–æ–≤–æ;
—â–æ–± –∑–±–µ—Ä–µ–≥—Ç–∏ —Ü—ñ –∑–º—ñ–Ω–∏ –≤ –ë–î ‚Äî –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–∫–æ–Ω–∞—Ç–∏ connection.commit() –≤—Ä—É—á–Ω—É.

‚ùó–ë–µ–∑ commit():
—Å—Ç–≤–æ—Ä–µ–Ω—ñ —Ç–∞–±–ª–∏—Ü—ñ –Ω–µ –∑–±–µ—Ä–µ–∂—É—Ç—å—Å—è,
–≤—Å—Ç–∞–≤–ª–µ–Ω—ñ –¥–∞–Ω—ñ –Ω–µ –∑–±–µ—Ä–µ–∂—É—Ç—å—Å—è,
–¥–ª—è DDL (—Ç–∏–ø—É CREATE, DROP, ALTER) —Ü–µ –æ—Å–æ–±–ª–∏–≤–æ –≤–∞–∂–ª–∏–≤–æ.

‚úÖ –©–æ —Ä–æ–±–∏—Ç—å connection.autocommit = True?

–ö–æ–ª–∏ —Ç–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î—à:
connection.autocommit = True
–¶–µ –æ–∑–Ω–∞—á–∞—î:

–∫–æ–∂–µ–Ω –∑–∞–ø–∏—Ç –æ–¥—Ä–∞–∑—É –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è —ñ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ –ë–î –±–µ–∑ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ—Å—Ç—ñ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ commit();
psycopg2 –Ω–µ —Å—Ç–≤–æ—Ä—é—î —è–≤–Ω—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é, –∞ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î –∫–æ–∂–µ–Ω –∑–∞–ø–∏—Ç –æ–¥—Ä–∞–∑—É –≤ –±–∞–∑—É.

üü¢ –ö–æ–ª–∏ —Ü–µ –∑—Ä—É—á–Ω–æ?
autocommit = True –∑—Ä—É—á–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏, –∫–æ–ª–∏:

–í–∏–ø–∞–¥–æ–∫	–ü–æ—è—Å–Ω–µ–Ω–Ω—è
CREATE TABLE, DROP TABLE, ALTER TABLE	–¶–µ DDL-–∫–æ–º–∞–Ω–¥–∏, —è–∫—ñ —á–∞—Å—Ç–æ –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è —Ä–∞–∑–æ–≤–æ, –±–µ–∑ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –º—ñ–∂ –Ω–∏–º–∏.
–°–∫—Ä–∏–ø—Ç–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó	–¢–∏ –ø—Ä–æ—Å—Ç–æ —Ö–æ—á–µ—à —à–≤–∏–¥–∫–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ë–î.
–í—Å—Ç–∞–≤–∫–∞ –ø–æ—á–∞—Ç–∫–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö	–Ø–∫—â–æ –Ω–µ —Ç—Ä–µ–±–∞ —Ä–æ–±–∏—Ç–∏ –±–∞–≥–∞—Ç–æ –≤—Å—Ç–∞–≤–æ–∫ —É —Ä–∞–º–∫–∞—Ö –æ–¥–Ω—ñ—î—ó —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó.


‚úÖ –ü—ñ—Å–ª—è –∑–∞–ø—É—Å–∫—É
–ö–æ–ª–∏ —Ç–∏ –≤–∏–∫–æ–Ω—É—î—à —Ü–µ–π —Ñ–∞–π–ª (python create_table.py), –≤—ñ–Ω:

–ü—ñ–¥–∫–ª—é—á–∞—î—Ç—å—Å—è –¥–æ PostgreSQL –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ —á–µ—Ä–µ–∑ –ø–æ—Ä—Ç 5434.
–í–∏–¥–∞–ª—è—î —Å—Ç–∞—Ä—ñ —Ç–∞–±–ª–∏—Ü—ñ (—è–∫—â–æ –±—É–ª–∏).
–°—Ç–≤–æ—Ä—é—î –Ω–æ–≤—ñ —Ç–∞–±–ª–∏—Ü—ñ –∑–≥—ñ–¥–Ω–æ –∑ –≤–∏–º–æ–≥–∞–º–∏.
'''